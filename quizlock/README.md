# Quiz Lock 仕様書

## 1. 概要

**Quiz Lock** は、指定した時間帯に特定のアプリを使用できなくし、クイズに正解したときだけ一時的に解除できる **自己管理用 iOS アプリ**です。

Screen Time / ManagedSettings を利用し、「意思」ではなく「仕組み」で行動を制御することを目的としています。

---

## 2. コンセプト / 設計思想

* アプリ使用を単純に禁止するのではなく、**「考える行為（クイズ）」を必須条件にする**
* 行動制御は報酬や強制ではなく、**納得感と自己選択**を重視
* 課金・広告に依存しない設計
* 個人利用を前提とした、**静かな自己管理ツール**

---

## 3. 機能仕様（現行版）

### 3.1 アプリ制限機能

#### 3.1.1 休止時間（Downtime）
* 指定した時間帯と曜日にアプリをブロック
* **日跨ぎの時間枠に対応**（例：23:00〜07:00）
* 時間枠内は、選択したアプリを **完全にブロック**
* 時間枠外では自動的にブロック解除
* **曜日選択**：Proプランで個別選択可能、Freeプランは全曜日のみ

#### 3.1.2 使用時間制限（App Limit）
* 1日の使用時間を制限（Proプランのみ）
* 制限に達すると、選択したアプリをブロック
* クイズに正解するまでブロック継続
* DeviceActivity APIを使用した実装

#### 3.1.3 日跨ぎ判定ロジック

**時間枠の種類**
* `start < end` → 同日内の時間枠（例：09:00〜18:00）
* `start > end` → 日跨ぎ時間枠（例：23:00〜07:00）
* `start == end` → 設定不可（24時間ロック相当になるため）

**ロック判定条件**
現在時刻が以下のいずれかに該当する場合、**ロック中**と判定。

* **同日枠**：`start ≤ now < end`
* **日跨ぎ枠**：`now ≥ start` **または** `now < end`

**並行ブロック**
* 休止時間と使用時間制限は **独立して動作**
* 両方が有効な場合、**和集合**でブロック（どちらかの条件を満たすアプリがブロックされる）

---

### 3.2 クイズ解除機能

#### 3.2.1 問題形式
* **4択形式**：選択肢から1つを選択
* **記述式**：テキスト入力で答えを記入（大文字小文字・前後の空白は無視）
* **ヒント機能**：問題にヒントを追加可能（任意）

#### 3.2.2 解除条件

**時間ベース解除**
* 正解すると指定時間だけ解除（1分〜23時間59分）
* デフォルト：10分

**問題数ベース解除**
* 指定問題数正解すると解除
* Freeプラン：1〜10問
* Proプラン：1〜100問

#### 3.2.3 スキップ機能
* 問題がわからないときに問題を解かずにスクリーンタイムを解除できる機能
* Freeプラン・Proプラン共に使用可能
* 有効/無効を設定可能
* 有効時のみクイズ画面に表示

#### 3.2.4 一時解除の扱い
* 正解時に **即時ブロック解除**
* 解除期間中はクイズ開始不可
* 解除期間終了後、**次回同期タイミングで再ブロック**

---

### 3.3 問題管理機能

#### 3.3.1 データ管理
* 問題データは **ローカル保存**（UserDefaults）
* UUID + schemaVersion による管理
* 追加 / 編集 / 削除に対応
* グループ機能で問題を分類

#### 3.3.2 問題作成
* 問題形式を選択（4択 / 記述式）
* 問題文を入力
* 4択の場合：選択肢4つと正解を設定
* 記述式の場合：正解の答えを設定（大文字小文字・前後の空白は無視して判定）
* ヒントを追加可能（任意）

#### 3.3.3 グループ機能
* 問題をグループに分類
* 複数グループを選択してクイズに出題
* グループごとに問題を管理
* 階層構造で表示（グループ一覧 → グループ詳細）
* グループの追加・編集・削除・共有に対応
* 問題の追加・編集・削除・共有に対応

#### 3.3.4 インポート/エクスポート
* **単一問題のインポート/エクスポート**：`.quizlock` 形式でファイル共有
* **グループ単位のインポート/エクスポート**：`.quizlock` 形式でファイル共有
* **インポート時の柔軟な選択**：
  - 新しいグループとして追加
  - 既存のグループに追加
  - 問題のみ追加（グループに所属させない）

#### 3.3.5 問題の移動・コピー機能
* **問題の移動**：グループ間で問題を移動できる
* **問題のコピー**：問題を複製して複数のグループに追加できる
* **グループのコピー**：グループ全体を複製できる（グループ名に「コピー」を付加）
* **新規グループ作成**：移動/コピー時に新しいグループを作成できる

#### 3.3.5 検索機能
* 問題管理画面で問題を検索
* グループ詳細画面でグループ内の問題を検索

---

### 3.4 課金機能（Proプラン）

#### 3.4.1 プラン
* **月額プラン**：300円/月
* **年額プラン**：3000円/年（月額換算250円/月）
* StoreKit 2を使用した自動更新サブスクリプション

#### 3.4.2 Proプラン機能
* **曜日選択**：休止時間の曜日を個別に選択可能
* **使用時間制限**：1日の使用時間を制限
* **個別アプリ制限**：休止時間と使用時間制限で異なるアプリを設定可能
* **問題数制限拡張**：問題数ベース解除で100問まで設定可能

#### 3.4.3 Freeプラン機能
* 休止時間：全曜日のみ
* 使用時間制限：利用不可
* 問題数ベース解除：10問まで
* スキップ機能：利用可能

---

## 4. 技術仕様

### 4.1 Screen Time / ブロック制御

#### 4.1.1 アプリ選択
* `FamilyActivityPicker` による対象アプリ選択
* Screen Time 権限が必要（`.approved` 状態）
* 休止時間と使用時間制限で独立してアプリを選択可能（Proプラン）

#### 4.1.2 ブロック実装
* `ManagedSettings` による **実ブロック**
* ブロック状態は `syncBlocking()` により制御
* 休止時間と使用時間制限の和集合でブロック

#### 4.1.3 使用時間制限の実装
* `DeviceActivity` APIを使用
* `DeviceActivityMonitor` Extensionで使用時間を監視
* 制限に達すると通知を送信
* App GroupsでメインアプリとExtension間でデータ共有

#### 4.1.4 同期タイミング
* アプリ起動時 (`onAppear`)
* アプリ復帰時 (`scenePhase.active`)
* 設定変更時

---

### 4.2 データ構造

#### 4.2.1 Question（問題）
```swift
struct Question {
    let id: UUID
    var type: QuestionType        // .multipleChoice または .textInput
    var questionText: String
    var choices: [String]?         // 4択の場合のみ（4つ）
    var correctIndex: Int?        // 4択の場合のみ（0...3）
    var correctAnswer: String?    // 記述式の場合のみ
    var hint: String?             // ヒント（任意）
}
```

#### 4.2.2 QuestionGroup（問題グループ）
```swift
struct QuestionGroup {
    let id: UUID
    var name: String
    var questionIds: [UUID]
    var createdAt: Date
    var updatedAt: Date
}
```

#### 4.2.3 QuestionPack（問題パック）
```swift
struct QuestionPack {
    let schemaVersion: Int
    var questions: [Question]
    var groups: [QuestionGroup]
    var selectedGroupIds: [UUID]  // クイズに出題するグループ
    var updatedAt: Date
}
```

#### 4.2.4 DowntimeSettings（休止時間設定）
```swift
struct DowntimeSettings {
    var startMinutes: Int          // 0..1439（分単位）
    var endMinutes: Int            // 0..1439（分単位）
    var enabledWeekdays: Set<Weekday>  // 適用する曜日
}
```

#### 4.2.5 AppLimitSettings（使用時間制限設定）
```swift
struct AppLimitSettings {
    var dailyLimitMinutes: Int?    // 1日の使用時間制限（分単位、nilの場合は無制限）
}
```

#### 4.2.6 LockSlot（ロック設定）
```swift
struct LockSlot {
    var downtime: DowntimeSettings
    var appLimit: AppLimitSettings
    var unlockConditionType: UnlockConditionType  // .timeBased または .questionBased
    var unlockDurationMinutes: Int                // 時間ベースの場合の解除時間（分）
    var unlockRequiredQuestions: Int              // 問題数ベースの場合の必要正解数
    var isSkipEnabled: Bool                       // スキップ機能の有効/無効
}
```

---

### 4.3 クイズ開始の制約

クイズを開始するには以下の条件を満たす必要があります：

1. **グループが選択されている**：問題管理画面で少なくとも1つのグループを選択
2. **選択されたグループに問題がある**：選択されたグループに少なくとも1つの問題が含まれている
3. **制限するアプリが設定されている**：休止時間または使用時間制限で少なくとも1つのアプリが選択されている
4. **解除中でない**：現在解除期間中でない（解除期間中はクイズ開始不可）

これらの条件を満たさない場合、適切なエラーメッセージが表示されます。

---

## 5. UI/UX仕様

### 5.1 デザイン方針
* **TickTick風**のシンプルで洗練されたデザイン
* 白ベースの背景
* 最小限の装飾、機能性を重視
* 視認性の高いコントラスト
* ダークモード対応

### 5.2 画面構成
* **ホーム画面**：状態表示、設定・問題管理への導線、クイズ開始ボタン
* **設定画面**：
  * 休止時間設定（別ページ）
  * 使用時間制限設定（別ページ）
  * 解除条件設定（別ページ）
* **問題管理画面**：グループ一覧、検索、インポート、グループ追加
* **グループ詳細画面**：グループ内の問題一覧、検索、問題追加
* **問題編集画面**：問題形式選択、問題文・選択肢・正解・ヒントの入力
* **クイズ画面**：問題表示、回答入力、正解/不正解フィードバック、スキップ機能
* **購入画面**：プラン選択、購入、復元

### 5.3 時間設定UI
* **休止時間**：iOS Screen Timeスタイルのホイールピッカー（x時y分形式）
* **使用時間制限**：ホイールピッカー（x時間y分形式）
* **解除時間**：ホイールピッカー（x時間y分形式）

---

## 6. 制約・前提条件

* 休止時間と使用時間制限は **完全に独立**して動作
* クイズ・設定画面は **ロック中でも編集可能**
* Screen Time の仕様上：
  * 再ロックは「同期タイミング」に依存
  * OS再起動・強制終了時の挙動は iOS に依存
* 解除期間中はクイズ開始不可

---

## 7. 将来設計 / 拡張構想

### 7.1 UX改善（優先度高）
* **Shield画面から直接「クイズへ」遷移**
* **解除期間終了後の自動再ロック（Timer導入）**
* ロック中の状態説明UI改善

### 7.2 時間制御の拡張
* **複数時間枠対応**
* **枠ごとの制限設定**
* **アプリごとの制限設定**

### 7.3 問題機能の拡張
* 出題ロジックの拡張（難易度別など）
* 問題の統計情報（正解率など）

### 7.4 問題共有構想
* ローカル共有（端末間）
* 友人間共有
* 将来的なコミュニティ化

※ 現時点では **外部通信なし**

### 7.5 海外対応
* **多言語対応**：英語、中国語、韓国語など主要言語への対応
* **地域別の課金設定**：各国の通貨・価格設定
* **文化的配慮**：各国の学習習慣に合わせたUI/UX調整

### 7.6 暗記帳機能
* **学習モード**：スクリーンタイム制限とは独立した学習モード
* **復習機能**：間違えた問題を自動的に復習リストに追加
* **学習進捗管理**：問題ごとの正解率・学習回数を記録
* **間隔反復学習**：忘却曲線に基づいた最適な復習タイミングの提案
* **カード形式表示**：暗記帳らしいカードUI

### 7.7 スクリーンタイム関係なしにクイズに挑戦する機能
* **練習モード**：制限なしでクイズに挑戦
* **学習モード**：問題を学習・復習するモード
* **統計機能**：正解率、学習時間などの統計情報
* **目標設定**：1日の学習目標を設定

### 7.8 Android対応
* **Android版の開発**：iOS版安定後にAndroid版を開発
* **クロスプラットフォーム化**：FlutterやReact Nativeなどのフレームワークを検討
* **データ同期**：iOSとAndroid間で問題データを同期（オプション）
* **Android固有機能**：Digital Wellbeing APIの活用

### 7.9 プラットフォーム展開
* **Web版**：ブラウザでクイズに挑戦できるWeb版
* **macOS版**：Macでも利用可能に

### 7.10 AI利用について
* 問題生成・学習支援などの可能性はあるが **当面は利用しない**
* 理由：
  * コスト
  * オフライン完結性の重視
  * 仕様の複雑化回避

---

## 8. 開発方針

* 行動設計を最優先
* 抜け道を前提に設計する
* 判断の履歴を README に残す
* 小さく作り、後から拡張する

---

## 9. ライセンス

MIT License

---

## 10. このドキュメントの位置づけ

* 現行仕様書
* 将来設計メモ
* 判断ログ
* 開発者自身のためのドキュメント
